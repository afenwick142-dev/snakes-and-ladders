// admin.js
// Admin portal logic for Snakes & Ladders

const API = "https://snakes-ladders-backend-github.onrender.com";
const ADMIN_IDLE_MS = 5 * 60 * 1000; // 5 minutes

// ----- ELEMENTS -----
const areaSelect = document.getElementById("adminArea");

const playersTableBody = document.getElementById("playersTableBody");
let playersAreaLabel = document.getElementById("playersAreaLabel");
const selectAllCheckbox = document.getElementById("selectAllPlayers");
const usersStatusEl = document.getElementById("usersStatus");

const grantCountInput = document.getElementById("grantCount");
const grantEveryoneBtn = document.getElementById("grantBtn");
const grantSelectedBtn = document.getElementById("grantSelectedBtn");
const undoGrantBtn = document.getElementById("undoGrantBtn");

const prizeCountInput = document.getElementById("prizeCount");
const prizeSaveBtn = document.getElementById("savePrizeBtn");
const prizeStatusEl = document.getElementById("prizeStatus");

const logoutBtn = document.getElementById("adminLogoutBtn");

// ----- HELPERS -----
function showStatus(msg, isError = false) {
  if (!usersStatusEl) return;
  usersStatusEl.textContent = msg || "";
  usersStatusEl.classList.remove("status-error", "status-ok");

  if (!msg) return;
  usersStatusEl.classList.add(isError ? "status-error" : "status-ok");
}

function showPrizeStatus(msg, isError = false) {
  if (!prizeStatusEl) return;
  prizeStatusEl.textContent = msg || "";
  prizeStatusEl.classList.remove("status-error", "status-ok");

  if (!msg) return;
  prizeStatusEl.classList.add(isError ? "status-error" : "status-ok");
}

function getSelectedArea() {
  return areaSelect?.value || "SW1";
}

// ----- AUTH / IDLE -----
function ensureLoggedIn() {
  const flag = localStorage.getItem("adminLoggedIn");
  const last = parseInt(localStorage.getItem("adminLastActive") || "0", 10);
  const now = Date.now();

  if (flag !== "yes" || !last || now - last > ADMIN_IDLE_MS) {
    localStorage.removeItem("adminLoggedIn");
    localStorage.removeItem("adminLastActive");
    window.location.href = "admin-login.html";
    return false;
  }
  return true;
}

function touchAdminActivity() {
  if (localStorage.getItem("adminLoggedIn") === "yes") {
    localStorage.setItem("adminLastActive", String(Date.now()));
  }
}

// ----- RENDERING -----
function renderPlayers(players, area) {
  if (!playersTableBody) return;

  playersTableBody.innerHTML = "";
  if (playersAreaLabel) {
    playersAreaLabel.textContent = area || getSelectedArea();
  }

  if (!players || players.length === 0) {
    const emptyRow = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 9;
    td.textContent = "No players found in this area yet.";
    emptyRow.appendChild(td);
    playersTableBody.appendChild(emptyRow);
    return;
  }

  for (const p of players) {
    const tr = document.createElement("tr");

    const selTd = document.createElement("td");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.className = "player-select";
    cb.dataset.email = p.email;
    selTd.appendChild(cb);
    tr.appendChild(selTd);

    const emailTd = document.createElement("td");
    emailTd.textContent = p.email;
    tr.appendChild(emailTd);

    const areaTd = document.createElement("td");
    areaTd.textContent = p.area || "";
    tr.appendChild(areaTd);

    const posTd = document.createElement("td");
    posTd.textContent = String(p.position ?? 0);
    tr.appendChild(posTd);

    const usedTd = document.createElement("td");
    usedTd.textContent = String(p.rollsUsed ?? 0);
    tr.appendChild(usedTd);

    const grantedTd = document.createElement("td");
    grantedTd.textContent = String(p.rollsGranted ?? 0);
    tr.appendChild(grantedTd);

    const completedTd = document.createElement("td");
    completedTd.textContent = p.completed ? "Yes" : "No";
    tr.appendChild(completedTd);

    const rewardTd = document.createElement("td");
    rewardTd.textContent = p.reward ? `£${p.reward}` : "—";
    tr.appendChild(rewardTd);

    const actionsTd = document.createElement("td");
    const resetBtn = document.createElement("button");
    resetBtn.textContent = "Reset";
    resetBtn.className = "btn btn-small btn-secondary";
    resetBtn.addEventListener("click", () => handleResetPlayer(p.email, p.area));
    actionsTd.appendChild(resetBtn);

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.className = "btn btn-small btn-danger";
    deleteBtn.addEventListener("click", () => handleDeletePlayer(p.email, p.area));
    actionsTd.appendChild(deleteBtn);

    tr.appendChild(actionsTd);

    playersTableBody.appendChild(tr);
  }
}

// ----- API CALLS -----
async function loadPlayersForArea() {
  if (!ensureLoggedIn()) return;

  const area = getSelectedArea();
  showStatus("Loading players...");

  try {
    const res = await fetch(
      `${API}/admin/players?area=${encodeURIComponent(area)}`
    );
    if (!res.ok) {
      showStatus("Failed to load players.", true);
      return;
    }
    const data = await res.json();
    renderPlayers(data.players || [], area);
    showStatus("");
  } catch (err) {
    console.error("Load players error:", err);
    showStatus("Server error.", true);
  }
}

async function handleResetPlayer(email, area) {
  if (!ensureLoggedIn()) return;
  if (!confirm(`Reset progress for ${email}?`)) return;

  try {
    const res = await fetch(`${API}/admin/reset-player`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, area }),
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.success) {
      showStatus(data.error || "Failed to reset player.", true);
      return;
    }

    showStatus("Player reset.");
    await loadPlayersForArea();
  } catch (err) {
    console.error("Reset player error:", err);
    showStatus("Server error.", true);
  }
}

async function handleDeletePlayer(email, area) {
  if (!ensureLoggedIn()) return;
  if (!confirm(`Delete player ${email} from ${area}?`)) return;

  try {
    const res = await fetch(`${API}/admin/delete-player`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, area }),
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.success) {
      showStatus(data.error || "Failed to delete player.", true);
      return;
    }

    showStatus("Player deleted.");
    await loadPlayersForArea();
  } catch (err) {
    console.error("Delete player error:", err);
    showStatus("Server error.", true);
  }
}

function getSelectedPlayerEmails() {
  const checkboxes = document.querySelectorAll(".player-select");
  const list = [];
  checkboxes.forEach((cb) => {
    if (cb.checked && cb.dataset.email) {
      list.push(cb.dataset.email);
    }
  });
  return list;
}

async function handleGrantRolls(onlySelected) {
  if (!ensureLoggedIn()) return;

  const area = getSelectedArea();
  const count = parseInt(grantCountInput?.value || "0", 10);
  if (!Number.isInteger(count) || count <= 0) {
    showStatus("Enter a positive number of extra rolls.", true);
    return;
  }

  let emails = [];
  if (onlySelected) {
    emails = getSelectedPlayerEmails();
    if (emails.length === 0) {
      showStatus("Select at least one player.", true);
      return;
    }
  }

  showStatus("Granting rolls...");

  try {
    const res = await fetch(`${API}/admin/grant-rolls`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        adminUsername: localStorage.getItem("adminUsername") || "admin",
        area,
        extraRolls: count,
        emails,
      }),
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.success) {
      showStatus(data.error || "Failed to grant rolls.", true);
      return;
    }

    showStatus("Rolls granted successfully.");
    await loadPlayersForArea();
  } catch (err) {
    console.error("Grant rolls error:", err);
    showStatus("Server error.", true);
  }
}

async function handleUndoGrant() {
  if (!ensureLoggedIn()) return;

  const area = getSelectedArea();
  if (!confirm(`Undo the last grant in ${area}?`)) return;

  showStatus("Undoing last grant...");

  try {
    const res = await fetch(`${API}/admin/undo-last-grant`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ area }),
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.success) {
      showStatus(data.error || "Failed to undo last grant.", true);
      return;
    }

    showStatus("Last grant undone.");
    await loadPlayersForArea();
  } catch (err) {
    console.error("Undo grant error:", err);
    showStatus("Server error.", true);
  }
}

async function loadPrizeConfig() {
  if (!ensureLoggedIn()) return;

  const area = getSelectedArea();
  showPrizeStatus("Loading prize settings...");

  try {
    const res = await fetch(
      `${API}/admin/prize-config?area=${encodeURIComponent(area)}`
    );
    if (!res.ok) {
      showPrizeStatus("Failed to load prize settings.", true);
      return;
    }
    const data = await res.json();
    const winners = data.winners ?? 0;
    if (prizeCountInput) {
      prizeCountInput.value = String(winners);
    }
    showPrizeStatus(`Max £25 Champions Points prizes allowed in ${area}: ${winners}.`);
  } catch (err) {
    console.error("Load prize config error:", err);
    showPrizeStatus("Server error.", true);
  }
}

async function savePrizeConfig() {
  if (!ensureLoggedIn()) return;

  const area = getSelectedArea();
  const winners = parseInt(prizeCountInput?.value || "0", 10);

  if (!Number.isInteger(winners) || winners < 0) {
    showPrizeStatus("Enter a valid non-negative number.", true);
    return;
  }

  showPrizeStatus("Saving prize settings...");

  try {
    const res = await fetch(`${API}/admin/prize-config`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ area, winners }),
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.success) {
      showPrizeStatus(data.error || "Failed to save prize settings.", true);
      return;
    }

    showPrizeStatus(
      `Max £25 Champions Points prizes allowed in ${area}: ${winners}.`
    );
  } catch (err) {
    console.error("Save prize config error:", err);
    showPrizeStatus("Server error.", true);
  }
}

function handleSelectAllToggle() {
  const checked = !!selectAllCheckbox?.checked;
  document
    .querySelectorAll(".player-select")
    .forEach((cb) => (cb.checked = checked));
}

// ----- INIT -----
function initAdmin() {
  ensureLoggedIn();

  setInterval(ensureLoggedIn, 60 * 1000);

  window.addEventListener("mousemove", touchAdminActivity);
  window.addEventListener("keydown", touchAdminActivity);
  window.addEventListener("click", touchAdminActivity);

  logoutBtn?.addEventListener("click", () => {
    localStorage.removeItem("adminLoggedIn");
    localStorage.removeItem("adminLastActive");
    window.location.href = "admin-login.html";
  });

  areaSelect?.addEventListener("change", () => {
    loadPlayersForArea();
    loadPrizeConfig();
  });

  grantEveryoneBtn?.addEventListener("click", () => handleGrantRolls(false));
  grantSelectedBtn?.addEventListener("click", () => handleGrantRolls(true));
  undoGrantBtn?.addEventListener("click", handleUndoGrant);

  prizeSaveBtn?.addEventListener("click", savePrizeConfig);

  selectAllCheckbox?.addEventListener("change", handleSelectAllToggle);

  if (getSelectedArea()) {
    loadPlayersForArea();
    loadPrizeConfig();
  } else {
    showStatus("Select an area to view players and prize settings.");
  }
}

document.addEventListener("DOMContentLoaded", initAdmin);
